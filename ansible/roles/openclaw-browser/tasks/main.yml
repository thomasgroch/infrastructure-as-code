---
# OpenClaw Browser Tool Setup
# Installs and configures Chrome for browser automation
# Avoids snap packages which don't work well with CDP

- name: Remove snap Chromium (if installed)
  snap:
    name: chromium
    state: absent
  ignore_errors: yes
  tags: [browser, snap]

- name: Install dependencies for Google Chrome
  apt:
    name:
      - wget
      - gnupg
      - libxss1
      - libappindicator3-1
      - libgtk-3-0
      - libgbm1
      - libasound2
      - fonts-liberation
      - libnss3
      - libxcomposite1
      - libxcursor1
      - libxdamage1
      - libxi6
      - libxtst6
      - libatk1.0-0
      - libatk-bridge2.0-0
      - libcups2
      - libdrm2
      - libxkbcommon0
      - libxrandr2
      - xdg-utils
    state: present
  tags: [browser, deps]

- name: Download Google Chrome
  get_url:
    url: https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    dest: /tmp/google-chrome-stable_current_amd64.deb
    mode: '0644'
  tags: [browser, chrome]

- name: Install Google Chrome
  apt:
    deb: /tmp/google-chrome-stable_current_amd64.deb
    state: present
  ignore_errors: yes
  register: chrome_install
  tags: [browser, chrome]

- name: Fix broken dependencies (if needed)
  command: apt-get --fix-broken install -y
  when: chrome_install is failed
  tags: [browser, chrome]

- name: Ensure Google Chrome is installed
  stat:
    path: /usr/bin/google-chrome-stable
  register: chrome_binary
  tags: [browser, chrome]

- name: Create symlink for chrome
  file:
    src: /usr/bin/google-chrome-stable
    dest: /usr/bin/chrome
    state: link
  when: chrome_binary.stat.exists
  tags: [browser, chrome]

- name: Create OpenClaw config directory
  file:
    path: /root/.openclaw
    state: directory
    mode: '0750'
  tags: [browser, config]

- name: Deploy OpenClaw browser configuration
  template:
    src: openclaw.json.j2
    dest: /root/.openclaw/openclaw.json
    mode: '0600'
  tags: [browser, config]

- name: Install Playwright dependencies
  apt:
    name:
      - libglib2.0-0
      - libnss3
      - libnspr4
      - libdbus-1-3
      - libatk1.0-0
      - libatk-bridge2.0-0
      - libcups2
      - libxcomposite1
      - libxdamage1
      - libxfixes3
      - libxrandr2
      - libgbm1
      - libpango-1.0-0
      - libcairo2
      - libasound2
      - libatspi2.0-0
    state: present
  tags: [browser, playwright]

- name: Verify Chrome installation
  command: google-chrome-stable --version
  register: chrome_version
  changed_when: false
  tags: [browser, verify]

- name: Display Chrome version
  debug:
    msg: "Installed: {{ chrome_version.stdout }}"
  tags: [browser, verify]
